<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¹´åº¦ç»˜ç”»æ€»ç»“</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f8f8f8;
            background-image: linear-gradient(rgba(220, 220, 220, 0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(220, 220, 220, 0.3) 1px, transparent 1px);
            background-size: 20px 20px;
            padding: 15px;
            color: #333;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #ddd;
            position: relative;
            width: 100%;
            overflow-x: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .header h1 {
            font-size: 1.8rem;
            font-weight: 300;
            letter-spacing: 3px;
            margin-bottom: 15px;
            word-break: break-word;
        }
        
        .header::before,
        .header::after {
            content: "âœ";
            position: absolute;
            top: 10px;
            font-size: 1.2rem;
            color: #555;
        }
        
        .header::before {
            left: 10px;
        }
        
        .header::after {
            right: 10px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            .header h1 {
                font-size: 1.5rem;
                letter-spacing: 2px;
            }
            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        @media (max-width: 400px) {
            body {
                padding: 5px;
            }
            .container {
                padding: 10px;
            }
            .header h1 {
                font-size: 1.3rem;
                letter-spacing: 1px;
                margin-bottom: 10px;
            }
            .header::before,
            .header::after {
                display: none;
            }
            .grid {
                gap: 10px;
            }
        }
        
        .month-card {
            border: 1px solid #ccc;
            padding: 15px;
            position: relative;
            transition: all 0.3s ease;
            background-color: white;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }
        
        .month-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .month-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            position: relative;
            word-break: break-word;
        }
        
        .month-title::before {
            content: "â–";
            margin-right: 8px;
            font-size: 1rem;
        }
        
        .image-container {
            width: 100%;
            height: 160px;
            border: 1px dashed #aaa;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            background-color: #f9f9f9;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }
        
        .image-container:active {
            background-color: #e8e8e8;
        }
        
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .image-placeholder {
            color: #888;
            font-size: 0.85rem;
            text-align: center;
            padding: 0 10px;
        }
        
        .image-placeholder::before {
            content: "ğŸ–¼";
            display: block;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .thoughts {
            min-height: 80px;
            border: 1px solid #ddd;
            padding: 10px;
            font-size: 0.85rem;
            line-height: 1.4;
            cursor: text;
            position: relative;
            word-break: break-word;
            overflow-wrap: break-word;
            -webkit-overflow-scrolling: touch;
        }
        
        .thoughts:empty:before {
            content: "ç‚¹å‡»æ­¤å¤„å†™ä¸‹æœ¬æœˆçš„ç»˜ç”»æ„Ÿæƒ³...";
            color: #aaa;
            font-size: 0.8rem;
        }
        
        .thoughts:focus {
            outline: 2px solid #333;
            outline-offset: -1px;
        }
        
        @media (max-width: 768px) {
            .month-title {
                font-size: 1.1rem;
            }
            .image-container {
                height: 140px;
            }
            .thoughts {
                min-height: 70px;
                font-size: 0.8rem;
            }
            .thoughts:empty:before {
                font-size: 0.75rem;
            }
        }
        
        .save-btn {
            display: block;
            margin: 30px auto 0;
            padding: 12px 25px;
            background-color: white;
            border: 1px solid #333;
            color: #333;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 44px;
            min-width: 120px;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }
        
        .save-btn:hover,
        .save-btn:active {
            background-color: #333;
            color: white;
        }
        
        .save-btn::before {
            content: "â¬‡";
            margin-right: 6px;
        }
        
        .clear-btn {
            display: block;
            margin: 10px auto 0;
            padding: 10px 20px;
            background-color: white;
            border: 1px solid #aaa;
            color: #666;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 44px;
            min-width: 120px;
            text-align: center;
        }
        
        .clear-btn:hover,
        .clear-btn:active {
            background-color: #f5f5f5;
            border-color: #888;
        }
        
        .footer {
            text-align: center;
            margin-top: 25px;
            font-size: 0.75rem;
            color: #777;
            line-height: 1.4;
        }
        
        .decoration {
            position: absolute;
            font-size: 1rem;
            color: #555;
            opacity: 0.5;
            display: none;
        }
        
        @media (min-width: 769px) {
            .decoration {
                display: block;
            }
            .dec-1 {
                top: 10%;
                left: 5%;
            }
            .dec-2 {
                top: 20%;
                right: 7%;
            }
            .dec-3 {
                bottom: 15%;
                left: 8%;
            }
            .dec-4 {
                bottom: 25%;
                right: 5%;
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            background: #333;
            color: white;
            padding: 12px;
            border-radius: 4px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        @media (max-width: 768px) {
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                padding: 10px;
                font-size: 0.85rem;
            }
        }
        
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }
        
        .progress-overlay.active {
            display: flex;
        }
        
        .progress-text {
            margin-top: 20px;
            font-size: 1rem;
            color: #333;
            text-align: center;
            max-width: 90%;
            padding: 0 15px;
        }
        
        @media (max-width: 768px) {
            .progress-text {
                font-size: 0.9rem;
                margin-top: 15px;
            }
        }
        
        .storage-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 0 0 15px 0;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #856404;
            text-align: center;
            display: none;
            line-height: 1.4;
        }
        
        .storage-warning.show {
            display: block;
        }
        /* æ–°å¢ï¼šå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */
        
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            flex-direction: column;
            padding: 20px;
        }
        
        .image-preview-modal.active {
            display: flex;
        }
        
        .preview-image-container {
            max-width: 100%;
            max-height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }
        
        .preview-image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .preview-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .preview-btn {
            padding: 10px 20px;
            background-color: white;
            border: none;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            min-height: 44px;
        }
        
        .preview-btn.save {
            background-color: #4CAF50;
            color: white;
        }
        
        .preview-btn.close {
            background-color: #f44336;
            color: white;
        }
        
        .preview-instruction {
            color: white;
            margin-top: 15px;
            font-size: 0.85rem;
            text-align: center;
            max-width: 90%;
        }
        
        [contenteditable="true"],
        .image-container,
        button {
            -webkit-user-select: auto;
            user-select: auto;
        }
        
        input,
        textarea,
        select,
        button {
            font-size: 16px;
        }
        
        .month-card,
        .image-container,
        .save-btn,
        .clear-btn {
            -webkit-touch-callout: none;
        }
    </style>
</head>

<body>
    <div class="notification" id="notification"></div>

    <div class="progress-overlay" id="progressOverlay">
        <div style="font-size: 2.5rem; color: #333;">âœ</div>
        <div class="progress-text" id="progressText">æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</div>
    </div>

    <!-- æ–°å¢ï¼šå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="image-preview-modal" id="imagePreviewModal">
        <div class="preview-image-container">
            <img id="previewImage" alt="é¢„è§ˆå›¾ç‰‡">
        </div>
        <div class="preview-controls">
            <button class="preview-btn save" id="savePreviewBtn">ä¿å­˜å›¾ç‰‡</button>
            <button class="preview-btn close" id="closePreviewBtn">å…³é—­</button>
        </div>
        <div class="preview-instruction" id="previewInstruction">
            é•¿æŒ‰å›¾ç‰‡å¹¶é€‰æ‹©"ä¿å­˜å›¾ç‰‡"å³å¯ä¿å­˜åˆ°æ‰‹æœº
        </div>
    </div>

    <div class="container" id="capture">
        <div class="storage-warning" id="storageWarning">
            æ³¨æ„ï¼šæµè§ˆå™¨å­˜å‚¨ç©ºé—´æœ‰é™ï¼Œç³»ç»Ÿä¼šæ™ºèƒ½å‹ç¼©å›¾ç‰‡ã€‚å»ºè®®å®šæœŸå¯¼å‡ºä¿å­˜æ‚¨çš„ä½œå“ã€‚
        </div>

        <div class="header">
            <h1 contenteditable="true">å¹´åº¦ç»˜ç”»æ€»ç»“</h1>
        </div>

        <div class="grid">
            <!-- 1æœˆåˆ°12æœˆçš„å¡ç‰‡ -->
            <div class="month-card" data-month="1">
                <h3 class="month-title" contenteditable="true">1æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>

            <div class="month-card" data-month="2">
                <h3 class="month-title" contenteditable="true">2æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>

            <div class="month-card" data-month="3">
                <h3 class="month-title" contenteditable="true">3æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>

            <div class="month-card" data-month="4">
                <h3 class="month-title" contenteditable="true">4æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>

            <div class="month-card" data-month="5">
                <h3 class="month-title" contenteditable="true">5æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>

            <div class="month-card" data-month="6">
                <h3 class="month-title" contenteditable="true">6æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>

            <div class="month-card" data-month="7">
                <h3 class="month-title" contenteditable="true">7æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>

            <div class="month-card" data-month="8">
                <h3 class="month-title" contenteditable="true">8æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>

            <div class="month-card" data-month="9">
                <h3 class="month-title" contenteditable="true">9æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>

            <div class="month-card" data-month="10">
                <h3 class="month-title" contenteditable="true">10æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>

            <div class="month-card" data-month="11">
                <h3 class="month-title" contenteditable="true">11æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>

            <div class="month-card" data-month="12">
                <h3 class="month-title" contenteditable="true">12æœˆ</h3>
                <div class="image-container">
                    <div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                </div>
                <div class="thoughts" contenteditable="true"></div>
            </div>
        </div>

        <button class="save-btn" id="saveBtn">ä¿å­˜ä¸ºå›¾ç‰‡</button>
        <button class="clear-btn" id="clearBtn">æ¸…é™¤æ‰€æœ‰å›¾ç‰‡</button>

        <div class="footer">
            <p>ç‚¹å‡»ä»»ä½•æ–‡å­—åŒºåŸŸè¿›è¡Œç¼–è¾‘ | ç‚¹å‡»å›¾ç‰‡åŒºåŸŸä¸Šä¼ å›¾ç‰‡ | ç‚¹å‡»ç©ºç™½å¤„ä¿å­˜</p>
        </div>

        <!-- è£…é¥°å…ƒç´  -->
        <div class="decoration dec-1">âœ</div>
        <div class="decoration dec-2">â–</div>
        <div class="decoration dec-3">â—ˆ</div>
        <div class="decoration dec-4">âœ¦</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æµ‹æ˜¯å¦åœ¨ç§»åŠ¨ç«¯
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // æ£€æµ‹æµè§ˆå™¨ç±»å‹
            const isBaiduBrowser = /baidubrowser/i.test(navigator.userAgent);
            const isWechat = /MicroMessenger/i.test(navigator.userAgent);

            // æ˜¾ç¤ºé€šçŸ¥
            function showNotification(message, duration = 3000) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');

                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            }

            // æ˜¾ç¤º/éšè—è¿›åº¦è¦†ç›–å±‚
            function showProgress(text) {
                const overlay = document.getElementById('progressOverlay');
                const progressText = document.getElementById('progressText');
                progressText.textContent = text;
                overlay.classList.add('active');
            }

            function hideProgress() {
                const overlay = document.getElementById('progressOverlay');
                overlay.classList.remove('active');
            }

            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
            function showImagePreview(imageSrc) {
                const modal = document.getElementById('imagePreviewModal');
                const previewImage = document.getElementById('previewImage');
                const instruction = document.getElementById('previewInstruction');

                previewImage.src = imageSrc;

                // æ ¹æ®ä¸åŒæµè§ˆå™¨æ˜¾ç¤ºä¸åŒçš„æç¤º
                if (isBaiduBrowser) {
                    instruction.textContent = 'é•¿æŒ‰å›¾ç‰‡å¹¶é€‰æ‹©"ä¿å­˜å›¾ç‰‡"å³å¯ä¿å­˜åˆ°æ‰‹æœº';
                } else if (isWechat) {
                    instruction.textContent = 'åœ¨å¾®ä¿¡ä¸­è¯·ç‚¹å‡»å³ä¸Šè§’èœå•ï¼Œé€‰æ‹©"åœ¨æµè§ˆå™¨æ‰“å¼€"åä¿å­˜å›¾ç‰‡';
                } else {
                    instruction.textContent = 'é•¿æŒ‰å›¾ç‰‡å¹¶é€‰æ‹©"ä¿å­˜å›¾ç‰‡"å³å¯ä¿å­˜åˆ°æ‰‹æœº';
                }

                modal.classList.add('active');

                // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
                document.body.style.overflow = 'hidden';
            }

            // éšè—å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†
            function hideImagePreview() {
                const modal = document.getElementById('imagePreviewModal');
                modal.classList.remove('active');

                // æ¢å¤èƒŒæ™¯æ»šåŠ¨
                document.body.style.overflow = '';
            }

            // æ˜¾ç¤ºå­˜å‚¨è­¦å‘Š
            function showStorageWarning() {
                document.getElementById('storageWarning').classList.add('show');
            }

            // éšè—å­˜å‚¨è­¦å‘Š
            function hideStorageWarning() {
                document.getElementById('storageWarning').classList.remove('show');
            }

            // é«˜çº§å›¾ç‰‡å‹ç¼©å‡½æ•° - é’ˆå¯¹ç”»ä½œä¼˜åŒ–
            function compressArtImage(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);

                    reader.onload = function(event) {
                        const img = new Image();
                        img.src = event.target.result;

                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;

                            // é’ˆå¯¹æ˜¾ç¤ºéœ€è¦è®¾ç½®æœ€å¤§å°ºå¯¸ - ä¿æŒå®½é«˜æ¯”
                            const MAX_WIDTH = 800;
                            const MAX_HEIGHT = 600;

                            // å¦‚æœå›¾ç‰‡å¾ˆå¤§ï¼Œå…ˆè¿›è¡Œç¼©å°
                            if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                                const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
                                width = Math.floor(width * ratio);
                                height = Math.floor(height * ratio);
                            }

                            // è®¾ç½®canvaså°ºå¯¸
                            canvas.width = width;
                            canvas.height = height;

                            const ctx = canvas.getContext('2d');

                            // å¡«å……ç™½è‰²èƒŒæ™¯
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(0, 0, width, height);

                            // ç»˜åˆ¶å›¾ç‰‡
                            ctx.drawImage(img, 0, 0, width, height);

                            // åŠ¨æ€è°ƒæ•´è´¨é‡
                            let quality = 0.5;

                            if (file.size > 15 * 1024 * 1024) {
                                quality = 0.4;
                            } else if (file.size > 10 * 1024 * 1024) {
                                quality = 0.45;
                            } else if (file.size > 5 * 1024 * 1024) {
                                quality = 0.5;
                            } else if (file.size > 2 * 1024 * 1024) {
                                quality = 0.6;
                            } else {
                                quality = 0.7;
                            }

                            // è½¬æ¢ä¸ºå‹ç¼©åçš„base64
                            const compressedBase64 = canvas.toDataURL('image/jpeg', quality);

                            // æ£€æŸ¥å‹ç¼©åçš„å¤§å°
                            const base64Length = compressedBase64.length;
                            const sizeInMB = (base64Length * 3 / 4) / (1024 * 1024);

                            console.log(`åŸå§‹å¤§å°: ${(file.size / (1024*1024)).toFixed(2)}MB, å‹ç¼©å: ${sizeInMB.toFixed(2)}MB`);

                            // å¦‚æœå‹ç¼©åä»ç„¶å¤§äº1MBï¼Œå°è¯•è¿›ä¸€æ­¥å‹ç¼©
                            if (sizeInMB > 1) {
                                console.log('å›¾ç‰‡ä»ç„¶è¾ƒå¤§ï¼Œè¿›è¡ŒäºŒæ¬¡å‹ç¼©...');
                                const secondaryCanvas = document.createElement('canvas');
                                const secondaryRatio = 0.7;
                                secondaryCanvas.width = Math.floor(width * secondaryRatio);
                                secondaryCanvas.height = Math.floor(height * secondaryRatio);

                                const secondaryCtx = secondaryCanvas.getContext('2d');
                                secondaryCtx.fillStyle = '#ffffff';
                                secondaryCtx.fillRect(0, 0, secondaryCanvas.width, secondaryCanvas.height);
                                secondaryCtx.drawImage(img, 0, 0, secondaryCanvas.width, secondaryCanvas.height);

                                const finalQuality = Math.max(0.3, quality * 0.8);
                                const finalBase64 = secondaryCanvas.toDataURL('image/jpeg', finalQuality);
                                resolve(finalBase64);
                            } else {
                                resolve(compressedBase64);
                            }
                        };

                        img.onerror = reject;
                    };

                    reader.onerror = reject;
                });
            }

            // å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
            const imageContainers = document.querySelectorAll('.image-container');

            imageContainers.forEach(container => {
                container.addEventListener('click', function() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';

                    input.onchange = async function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            if (file.size > 20 * 1024 * 1024) {
                                showNotification('å›¾ç‰‡å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº20MBçš„å›¾ç‰‡');
                                return;
                            }

                            showProgress('æ­£åœ¨å‹ç¼©å›¾ç‰‡...');

                            try {
                                const compressedImage = await compressArtImage(file);

                                const img = document.createElement('img');
                                img.src = compressedImage;

                                container.innerHTML = '';
                                container.appendChild(img);

                                const month = container.closest('.month-card').getAttribute('data-month');

                                try {
                                    localStorage.setItem(`painting-image-${month}`, compressedImage);
                                    showNotification('å›¾ç‰‡å·²ä¿å­˜');

                                    localStorage.setItem(`painting-time-${month}`, Date.now().toString());

                                    manageStorageSpace();
                                } catch (storageError) {
                                    console.error('å­˜å‚¨å¤±è´¥:', storageError);
                                    showProgress('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œæ­£åœ¨æ¸…ç†...');

                                    const success = await forceClearStorage();

                                    if (success) {
                                        try {
                                            localStorage.setItem(`painting-image-${month}`, compressedImage);
                                            localStorage.setItem(`painting-time-${month}`, Date.now().toString());
                                            showNotification('å­˜å‚¨ç©ºé—´å·²æ¸…ç†ï¼Œå›¾ç‰‡å·²ä¿å­˜');
                                        } catch (retryError) {
                                            console.error('é‡è¯•å­˜å‚¨å¤±è´¥:', retryError);
                                            showNotification('å›¾ç‰‡å¤ªå¤§ï¼Œæ— æ³•ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                                        }
                                    } else {
                                        showNotification('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œæ— æ³•ä¿å­˜å›¾ç‰‡');
                                    }
                                }
                            } catch (error) {
                                console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error);
                                showNotification('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
                            } finally {
                                hideProgress();
                            }
                        }
                    };

                    input.click();
                });
            });

            // å­˜å‚¨ç©ºé—´ç®¡ç†å‡½æ•°
            function manageStorageSpace() {
                try {
                    const imageEntries = [];

                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('painting-image-')) {
                            const month = key.replace('painting-image-', '');
                            const timestamp = localStorage.getItem(`painting-time-${month}`) || '0';
                            imageEntries.push({
                                month: month,
                                timestamp: parseInt(timestamp),
                                size: localStorage.getItem(key).length
                            });
                        }
                    }

                    imageEntries.sort((a, b) => a.timestamp - b.timestamp);

                    const totalSize = imageEntries.reduce((sum, entry) => sum + entry.size, 0);
                    const maxSize = 4 * 1024 * 1024;

                    if (totalSize > maxSize) {
                        showStorageWarning();

                        let currentSize = totalSize;
                        for (let i = 0; i < imageEntries.length && currentSize > maxSize; i++) {
                            const entry = imageEntries[i];
                            localStorage.removeItem(`painting-image-${entry.month}`);
                            localStorage.removeItem(`painting-time-${entry.month}`);
                            currentSize -= entry.size;
                            console.log(`æ¸…ç†äº† ${entry.month}æœˆçš„å›¾ç‰‡`);
                        }
                    } else {
                        hideStorageWarning();
                    }
                } catch (e) {
                    console.error('å­˜å‚¨ç®¡ç†é”™è¯¯:', e);
                }
            }

            // å¼ºåˆ¶æ¸…ç†å­˜å‚¨ç©ºé—´
            async function forceClearStorage() {
                return new Promise((resolve) => {
                    try {
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('painting-image-')) {
                                localStorage.removeItem(key);
                            }
                            if (key.startsWith('painting-time-')) {
                                localStorage.removeItem(key);
                            }
                        }

                        const keysToKeep = [
                            'header-title',
                            'month-title-1', 'month-title-2', 'month-title-3', 'month-title-4',
                            'month-title-5', 'month-title-6', 'month-title-7', 'month-title-8',
                            'month-title-9', 'month-title-10', 'month-title-11', 'month-title-12',
                            'thoughts-1', 'thoughts-2', 'thoughts-3', 'thoughts-4',
                            'thoughts-5', 'thoughts-6', 'thoughts-7', 'thoughts-8',
                            'thoughts-9', 'thoughts-10', 'thoughts-11', 'thoughts-12'
                        ];

                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (!keysToKeep.includes(key)) {
                                localStorage.removeItem(key);
                            }
                        }

                        resolve(true);
                    } catch (e) {
                        console.error('å¼ºåˆ¶æ¸…ç†å¤±è´¥:', e);
                        resolve(false);
                    }
                });
            }

            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å›¾ç‰‡
            document.querySelectorAll('.month-card').forEach(card => {
                const month = card.getAttribute('data-month');
                const savedImage = localStorage.getItem(`painting-image-${month}`);
                const imageContainer = card.querySelector('.image-container');

                if (savedImage) {
                    imageContainer.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = savedImage;
                    imageContainer.appendChild(img);
                }
            });

            // ä¿å­˜ç¼–è¾‘å†…å®¹
            const editableElements = document.querySelectorAll('[contenteditable="true"]');

            editableElements.forEach(element => {
                const card = element.closest('.month-card');
                const month = card ? card.getAttribute('data-month') : 'header';

                let key;
                if (element.classList.contains('month-title')) {
                    key = `month-title-${month}`;
                } else if (element.classList.contains('thoughts')) {
                    key = `thoughts-${month}`;
                } else {
                    key = 'header-title';
                }

                const savedContent = localStorage.getItem(key);
                if (savedContent) {
                    element.innerHTML = savedContent;
                }

                let saveTimeout;
                element.addEventListener('input', function() {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        saveContent(element);
                    }, 1000);
                });

                element.addEventListener('blur', function() {
                    saveContent(element);
                });
            });

            function saveContent(element) {
                const card = element.closest('.month-card');
                const month = card ? card.getAttribute('data-month') : 'header';

                let key;
                if (element.classList.contains('month-title')) {
                    key = `month-title-${month}`;
                } else if (element.classList.contains('thoughts')) {
                    key = `thoughts-${month}`;
                } else {
                    key = 'header-title';
                }

                try {
                    localStorage.setItem(key, element.innerHTML);
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯
                }
            }

            // ä¼˜åŒ–çš„ä¿å­˜å›¾ç‰‡åŠŸèƒ½
            document.getElementById('saveBtn').addEventListener('click', async function() {
                this.disabled = true;
                this.textContent = 'æ­£åœ¨ç”Ÿæˆ...';
                showProgress('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...');

                try {
                    // ä¼˜åŒ–html2canvasé…ç½®ï¼Œé¿å…å†…å­˜é—®é¢˜å’Œç™½å±
                    const canvas = await html2canvas(document.getElementById('capture'), {
                        scale: isMobile ? 1.5 : 2, // ç§»åŠ¨ç«¯é™ä½scaleå‡å°‘å†…å­˜å ç”¨
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        removeContainer: true, // æ¸…ç†ä¸´æ—¶å®¹å™¨
                        onclone: function(clonedDoc) {
                            // æ¸…ç†ä¸éœ€è¦çš„å…ƒç´ ï¼Œå‡å°‘å†…å­˜å ç”¨
                            const progressOverlay = clonedDoc.getElementById('progressOverlay');
                            if (progressOverlay) progressOverlay.style.display = 'none';

                            const notification = clonedDoc.getElementById('notification');
                            if (notification) notification.style.display = 'none';

                            // éšè—ä¸éœ€è¦çš„è£…é¥°å…ƒç´ 
                            const decorations = clonedDoc.querySelectorAll('.decoration');
                            decorations.forEach(dec => dec.style.display = 'none');
                        }
                    });

                    hideProgress();

                    const imageData = canvas.toDataURL('image/png');

                    // æ ¹æ®ä¸åŒè®¾å¤‡å’Œæµè§ˆå™¨é‡‡å–ä¸åŒçš„ä¿å­˜ç­–ç•¥
                    if (isMobile) {
                        // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºé¢„è§ˆï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨ä¿å­˜
                        showImagePreview(imageData);

                        // åœ¨å¾®ä¿¡ä¸­ç‰¹æ®Šæç¤º
                        if (isWechat) {
                            showNotification('å¾®ä¿¡ä¸­è¯·ç‚¹å‡»å³ä¸Šè§’èœå•ï¼Œé€‰æ‹©"åœ¨æµè§ˆå™¨æ‰“å¼€"åä¿å­˜å›¾ç‰‡', 5000);
                        }
                    } else {
                        // æ¡Œé¢ç«¯ï¼šç›´æ¥ä¸‹è½½
                        const link = document.createElement('a');
                        link.download = `å¹´åº¦ç»˜ç”»æ€»ç»“_${new Date().toISOString().slice(0, 10)}.png`;
                        link.href = imageData;
                        link.click();
                        showNotification('å›¾ç‰‡ä¿å­˜æˆåŠŸï¼Œæ­£åœ¨ä¸‹è½½...');
                    }
                } catch (error) {
                    console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                    hideProgress();

                    // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„æç¤º
                    if (error.message && error.message.includes('memory') || error.message.includes('timeout')) {
                        showNotification('ç”Ÿæˆå›¾ç‰‡æ—¶å†…å­˜ä¸è¶³ï¼Œè¯·å°è¯•å‡å°‘å›¾ç‰‡æ•°é‡æˆ–é‡å¯æµè§ˆå™¨');
                    } else if (error.message && error.message.includes('security')) {
                        showNotification('å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
                    } else {
                        showNotification('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–ä½¿ç”¨æˆªå›¾åŠŸèƒ½ä¿å­˜');
                    }

                    // æä¾›ä¸€ä¸ªå¤‡é€‰æ–¹æ¡ˆï¼šè®©ç”¨æˆ·æˆªå›¾
                    setTimeout(() => {
                        if (confirm('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œæ˜¯å¦ä½¿ç”¨æ‰‹æœºæˆªå›¾åŠŸèƒ½ä¿å­˜ï¼Ÿ\n\nå¯ä»¥åŒæ—¶æŒ‰ä¸‹éŸ³é‡ä¸‹é”®å’Œç”µæºé”®è¿›è¡Œæˆªå›¾ã€‚')) {
                            showNotification('è¯·ä½¿ç”¨æ‰‹æœºæˆªå›¾åŠŸèƒ½ä¿å­˜å½“å‰é¡µé¢');
                        }
                    }, 500);
                } finally {
                    this.disabled = false;
                    this.textContent = 'ä¿å­˜ä¸ºå›¾ç‰‡';
                }
            });

            // é¢„è§ˆæ¨¡æ€æ¡†çš„ä¿å­˜æŒ‰é’®
            document.getElementById('savePreviewBtn').addEventListener('click', function() {
                const previewImage = document.getElementById('previewImage');
                const imageSrc = previewImage.src;

                // å°è¯•ä½¿ç”¨ä¸åŒçš„ä¿å­˜æ–¹æ³•
                try {
                    // æ–¹æ³•1ï¼šä½¿ç”¨aæ ‡ç­¾ä¸‹è½½
                    const link = document.createElement('a');
                    link.download = `å¹´åº¦ç»˜ç”»æ€»ç»“_${new Date().toISOString().slice(0, 10)}.png`;
                    link.href = imageSrc;

                    // å¯¹äºç§»åŠ¨ç«¯ï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ç‚¹å‡»äº‹ä»¶
                    const clickEvent = new MouseEvent('click', {
                        view: window,
                        bubbles: true,
                        cancelable: true
                    });

                    link.dispatchEvent(clickEvent);

                    showNotification('å·²å°è¯•ä¿å­˜å›¾ç‰‡ï¼Œè¯·æ ¹æ®æµè§ˆå™¨æç¤ºæ“ä½œ');
                } catch (error) {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é•¿æŒ‰å›¾ç‰‡æ‰‹åŠ¨ä¿å­˜');
                }
            });

            // é¢„è§ˆæ¨¡æ€æ¡†çš„å…³é—­æŒ‰é’®
            document.getElementById('closePreviewBtn').addEventListener('click', function() {
                hideImagePreview();
            });

            // æ¸…é™¤æ‰€æœ‰å›¾ç‰‡æŒ‰é’®
            document.getElementById('clearBtn').addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ä¸Šä¼ çš„å›¾ç‰‡å—ï¼Ÿæ–‡å­—å†…å®¹å°†ä¿ç•™ã€‚')) {
                    showProgress('æ­£åœ¨æ¸…é™¤å›¾ç‰‡...');

                    try {
                        for (let i = 1; i <= 12; i++) {
                            localStorage.removeItem(`painting-image-${i}`);
                            localStorage.removeItem(`painting-time-${i}`);

                            const container = document.querySelector(`.month-card[data-month="${i}"] .image-container`);
                            if (container) {
                                container.innerHTML = '<div class="image-placeholder">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>';
                            }
                        }

                        showNotification('æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤');
                        hideStorageWarning();
                    } catch (e) {
                        console.error('æ¸…é™¤å›¾ç‰‡å¤±è´¥:', e);
                        showNotification('æ¸…é™¤å¤±è´¥');
                    } finally {
                        hideProgress();
                    }
                }
            });

            // åˆå§‹åŒ–æ—¶æ£€æŸ¥å­˜å‚¨çŠ¶æ€
            setTimeout(() => {
                manageStorageSpace();
                showNotification('æ”¯æŒä¸Šä¼ 20MBä»¥å†…çš„å›¾ç‰‡ï¼Œç³»ç»Ÿä¼šæ™ºèƒ½å‹ç¼©å¤„ç†', 5000);
            }, 1000);

            // ç§»åŠ¨ç«¯è™šæ‹Ÿé”®ç›˜å¤„ç†
            let viewportMeta = document.querySelector('meta[name="viewport"]');
            if (viewportMeta && 'ontouchstart' in window) {
                document.addEventListener('focusin', function() {
                    viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                });

                document.addEventListener('focusout', function() {
                    setTimeout(() => {
                        viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                    }, 100);
                });
            }

            // æ·»åŠ é•¿æŒ‰ä¿å­˜æç¤º
            document.getElementById('previewImage').addEventListener('touchstart', function(e) {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    const startX = touch.clientX;
                    const startY = touch.clientY;
                    const startTime = Date.now();

                    const touchMoveHandler = function(moveEvent) {
                        const moveTouch = moveEvent.touches[0];
                        const deltaX = Math.abs(moveTouch.clientX - startX);
                        const deltaY = Math.abs(moveTouch.clientY - startY);

                        // å¦‚æœç§»åŠ¨è·ç¦»å¤ªå¤§ï¼Œå–æ¶ˆé•¿æŒ‰æ£€æµ‹
                        if (deltaX > 10 || deltaY > 10) {
                            document.removeEventListener('touchmove', touchMoveHandler);
                            document.removeEventListener('touchend', touchEndHandler);
                        }
                    };

                    const touchEndHandler = function() {
                        const duration = Date.now() - startTime;

                        // å¦‚æœé•¿æŒ‰è¶…è¿‡500msï¼Œæ˜¾ç¤ºä¿å­˜æç¤º
                        if (duration > 500) {
                            showNotification('é•¿æŒ‰å›¾ç‰‡å¯ä¿å­˜åˆ°æ‰‹æœºç›¸å†Œ');
                        }

                        document.removeEventListener('touchmove', touchMoveHandler);
                        document.removeEventListener('touchend', touchEndHandler);
                    };

                    document.addEventListener('touchmove', touchMoveHandler);
                    document.addEventListener('touchend', touchEndHandler);
                }
            });
        });
    </script>
</body>

</html>